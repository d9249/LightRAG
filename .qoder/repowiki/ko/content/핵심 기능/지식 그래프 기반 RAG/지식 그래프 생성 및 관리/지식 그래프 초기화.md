# 지식 그래프 초기화

<cite>
**이 문서에서 참조된 파일**
- [lightrag.py](file://lightrag/lightrag.py)
- [namespace.py](file://lightrag/namespace.py)
- [base.py](file://lightrag/base.py)
- [json_kv_impl.py](file://lightrag/kg/json_kv_impl.py)
- [nano_vector_db_impl.py](file://lightrag/kg/nano_vector_db_impl.py)
- [networkx_impl.py](file://lightrag/kg/networkx_impl.py)
- [shared_storage.py](file://lightrag/kg/shared_storage.py)
</cite>

## 목차
1. [소개](#소개)
2. [LightRAG 클래스 초기화 개요](#lightrag-클래스-초기화-개요)
3. [__post_init__ 메서드에서의 저장소 생성 및 설정](#post_init-메서드에서의-저장소-생성-및-설정)
4. [저장소 네임스페이스 및 워크스페이스 구성](#저장소-네임스페이스-및-워크스페이스-구성)
5. [initialize_storages() 메서드와 초기화 순서](#initialize_storages-메서드와-초기화-순서)
6. [결론](#결론)

## 소개

LightRAG 프레임워크는 지식 기반의 정보 검색과 생성을 위한 고성능 시스템으로, 다양한 저장소 인스턴스를 사용하여 데이터를 효율적으로 관리합니다. 이 문서는 LightRAG 클래스가 초기화될 때 `chunk_entity_relation_graph`, `entities_vdb`, `relationships_vdb` 등의 저장소 인스턴스를 어떻게 생성하고 설정하는지에 대해 설명합니다. 특히 `__post_init__` 메서드에서 저장소 클래스를 가져오고 `partial` 함수를 사용하여 전역 설정을 바인딩하는 과정을 상세히 설명하며, 각 저장소의 네임스페이스와 워크스페이스 구성, `embedding_func`과 `global_config`의 전달 방식, 그리고 `initialize_storages()` 메서드가 비동기적으로 각 저장소를 순차적으로 초기화하는 방식과 저장소 간 초기화 순서의 중요성을 다룹니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)

## LightRAG 클래스 초기화 개요

LightRAG 클래스는 데이터 저장 및 검색을 위한 다양한 저장소를 관리합니다. 초기화 과정에서 이 클래스는 키-값 저장소, 벡터 저장소, 그래프 저장소, 문서 상태 저장소 등을 설정하며, 각 저장소는 특정 목적에 맞게 구성됩니다. 초기화는 `__post_init__` 메서드에서 수행되며, 여기서 저장소 클래스가 가져와지고 전역 설정이 바인딩됩니다. 이후 `initialize_storages()` 메서드를 통해 각 저장소가 비동기적으로 초기화됩니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)

## __post_init__ 메서드에서의 저장소 생성 및 설정

`__post_init__` 메서드는 LightRAG 인스턴스가 생성된 후 자동으로 호출되며, 저장소 인스턴스의 생성과 설정을 담당합니다. 이 메서드는 다음과 같은 주요 단계를 포함합니다:

1. **전역 설정 고정**: `asdict(self)`를 사용하여 LightRAG 인스턴스의 모든 속성을 딕셔너리 형태로 변환하여 `global_config`에 저장합니다. 이 설정은 이후 모든 저장소에 전달됩니다.
2. **저장소 클래스 가져오기**: `_get_storage_class` 메서드를 사용하여 `kv_storage`, `vector_storage`, `graph_storage`, `doc_status_storage`에 지정된 저장소 클래스를 가져옵니다.
3. **partial 함수를 사용한 전역 설정 바인딩**: `partial` 함수를 사용하여 각 저장소 클래스에 `global_config`를 바인딩합니다. 이를 통해 각 저장소 인스턴스 생성 시 자동으로 전역 설정이 전달됩니다.
4. **저장소 인스턴스 생성**: 바인딩된 클래스를 사용하여 `llm_response_cache`, `text_chunks`, `full_docs`, `full_entities`, `full_relations`, `chunk_entity_relation_graph`, `entities_vdb`, `relationships_vdb`, `chunks_vdb`, `doc_status` 등의 저장소 인스턴스를 생성합니다.

이 과정을 통해 각 저장소는 일관된 설정을 바탕으로 생성되며, 시스템 전체의 일관성을 유지합니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)

## 저장소 네임스페이스 및 워크스페이스 구성

각 저장소는 고유한 네임스페이스와 워크스페이스를 사용하여 데이터를 격리하고 관리합니다. 네임스페이스는 `namespace.py` 파일에 정의된 `NameSpace` 클래스를 통해 제공되며, 각 저장소 유형에 따라 다음과 같은 네임스페이스가 사용됩니다:

- **KV 저장소**: `KV_STORE_FULL_DOCS`, `KV_STORE_TEXT_CHUNKS`, `KV_STORE_LLM_RESPONSE_CACHE`, `KV_STORE_FULL_ENTITIES`, `KV_STORE_FULL_RELATIONS`
- **벡터 저장소**: `VECTOR_STORE_ENTITIES`, `VECTOR_STORE_RELATIONSHIPS`, `VECTOR_STORE_CHUNKS`
- **그래프 저장소**: `GRAPH_STORE_CHUNK_ENTITY_RELATION`
- **문서 상태 저장소**: `DOC_STATUS`

워크스페이스는 데이터 격리를 위해 사용되며, `working_dir` 내에 워크스페이스 이름을 포함한 디렉터리 구조를 생성합니다. 예를 들어, `workspace`가 "my_workspace"이고 `namespace`가 "full_docs"인 경우, 최종 네임스페이스는 "my_workspace_full_docs"가 되며, 데이터 파일은 `working_dir/my_workspace/kv_store_full_docs.json`에 저장됩니다.

`embedding_func`과 `global_config`은 저장소 인스턴스 생성 시 각 저장소의 생성자에 전달되며, 이를 통해 각 저장소는 필요한 설정과 기능을 사용할 수 있습니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)
- [namespace.py](file://lightrag/namespace.py#L0-L26)

## initialize_storages() 메서드와 초기화 순서

`initialize_storages()` 메서드는 비동기적으로 각 저장소를 순차적으로 초기화합니다. 이 메서드는 저장소 간의 의존성을 고려하여 초기화 순서를 정하며, 데드락을 방지하기 위해 하나씩 초기화합니다. 초기화 순서는 다음과 같습니다:

1. `full_docs`
2. `text_chunks`
3. `full_entities`
4. `full_relations`
5. `entities_vdb`
6. `relationships_vdb`
7. `chunks_vdb`
8. `chunk_entity_relation_graph`
9. `llm_response_cache`
10. `doc_status`

이 순서는 데이터 흐름과 의존성을 반영합니다. 예를 들어, `chunk_entity_relation_graph`는 다른 저장소에서 생성된 데이터를 기반으로 하므로, 이 저장소는 나중에 초기화됩니다. 각 저장소는 `initialize()` 메서드를 호출하여 내부 상태를 설정하고, 필요한 경우 파일에서 데이터를 로드합니다. 초기화가 완료되면 `_storages_status`가 `INITIALIZED`로 설정됩니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)

## 결론

LightRAG 클래스의 초기화 과정은 저장소 인스턴스의 생성과 설정, 네임스페이스 및 워크스페이스 구성, 전역 설정의 전달, 그리고 비동기적인 초기화 순서를 포함하여 체계적으로 이루어집니다. `__post_init__` 메서드는 저장소 클래스를 가져와 `partial` 함수를 사용하여 전역 설정을 바인딩하고, 각 저장소 인스턴스를 생성합니다. `initialize_storages()` 메서드는 저장소 간의 의존성을 고려하여 순차적으로 초기화함으로써 시스템의 안정성과 일관성을 보장합니다. 이러한 구조는 LightRAG가 효율적이고 확장 가능한 지식 기반 시스템으로 동작할 수 있도록 합니다.

**Section sources**
- [lightrag.py](file://lightrag/lightrag.py#L0-L2928)