
# 엔티티 및 관계 추출

<cite>
**이 문서에서 참조된 파일**
- [operate.py](file://lightrag/operate.py)
- [prompt.py](file://lightrag/prompt.py)
- [constants.py](file://lightrag/constants.py)
- [utils.py](file://lightrag/utils.py)
</cite>

## 목차
1. [소개](#소개)
2. [엔티티 추출 메커니즘](#엔티티-추출-메커니즘)
3. [프롬프트 템플릿 구조](#프롬프트-템플릿-구조)
4. [기본 엔티티 유형의 영향](#기본-엔티티-유형의-영향)
5. [재시도 메커니즘](#재시도-메커니즘)
6. [단일 엔티티 및 관계 처리](#단일-엔티티-및-관계-처리)
7. [데이터 품질 보장 유틸리티](#데이터-품질-보장-유틸리티)

## 소개
이 문서는 LightRAG 시스템의 핵심 기능인 엔티티 및 관계 추출 메커니즘을 심층적으로 분석합니다. `operate.py` 모듈의 `extract_entities` 함수가 텍스트에서 정보를 추출하는 방식, `prompt.py`에 정의된 `entity_extraction` 프롬프트 템플릿의 구조와 역할, `DEFAULT_ENTITY_TYPES` 상수가 추출 프로세스에 미치는 영향, 그리고 실패한 추출 시도를 처리하는 재시도 메커니즘(`entity_extract_max_gleaning`)에 대해 설명합니다. 또한 `_handle_single_entity_extraction`과 `_handle_single_relationship_extraction` 함수의 내부 로직과 `sanitize_text_for_encoding`, `clean_str` 같은 유틸리티 함수가 데이터 품질을 보장하는 방법을 분석합니다.

## 엔티티 추출 메커니즘
`extract_entities` 함수는 텍스트 청크에서 엔티티와 관계를 추출하는 핵심 함수입니다. 이 함수는 LLM(대규모 언어 모델)을 활용하여 구조화된 정보를 추출합니다. 프로세스는 다음과 같습니다.

먼저, 함수는 전역 설정에서 언어와 엔티티 유형을 가져옵니다. 언어는 `DEFAULT_SUMMARY_LANGUAGE` 상수를 기반으로 하며, 엔티티 유형은 `DEFAULT_ENTITY_TYPES` 상수를 기반으로 합니다. 이 설정들은 사용자 정의 가능하며, `.env` 파일이나 전역 설정을 통해 재정의할 수 있습니다.

추출 프로세스는 두 단계로 나뉩니다. 첫 번째 단계는 초기 추출입니다. 함수는 `entity_extract_prompt`를 사용하여 LLM에 텍스트 청크를 전달하고, 엔티티와 관계를 추출합니다. 이 프롬프트는 `prompt.py` 파일에 정의된 `entity_extraction` 템플릿을 기반으로 하며, 엔티티 이름, 유형, 설명 및 관계 정보를 구조화된 형식으로 요청합니다.

두 번째 단계는 추가적인 정보를 추출하기 위한 재시도(재수확, gleaning)입니다. 초기 추출 후, 시스템은 `entity_continue_extraction` 프롬프트를 사용하여 누락된 엔티티와 관계를 찾습니다. 이 프롬프트는 이전에 추출된 결과를 기반으로 추가 정보를 요청합니다. 이 과정은 `entity_extract_max_gleaning` 설정 값에 따라 반복되며, 각 반복에서 새로운 정보가 발견되면 기존 결과에 병합됩니다. 병합 시에는 이름이 중복되지 않는 새로운 엔티티와 관계만 추가됩니다.

추출된 결과는 `_process_extraction_result` 함수를 통해 처리됩니다. 이 함수는 LLM의 응답을 파싱하여 엔티티와 관계를 분리하고, `_handle_single_entity_extraction` 및 `_handle_single_relationship_extraction` 함수를 호출하여 각 항목을 검증하고 정제합니다. 최종적으로 추출된 모든 결과는 `merge_nodes_and_edges` 함수로 전달되어 지식 그래프에 통합됩니다.

**Section sources**
- [operate.py](file://lightrag/operate.py#L1674-L1914)

## 프롬프트 템플릿 구조
`prompt.py` 파일에 정의된 `entity_extraction` 프롬프트 템플릿은 엔티티 및 관계 추출의 지침서 역할을 합니다. 이 템플릿은 LLM이 구조화된 출력을 생성하도록 명확한 지시를 제공합니다.

템플릿의 구조는 다음과 같습니다:

1.  **목표(Goal)**: 주어진 텍스트 문서에서 지정된 엔티티 유형의 모든 엔티티와 그들 사이의 관계를 식별하라는 명확한 목표를 제시합니다. 출력 언어도 지정됩니다.

2.  **단계(Steps)**: 추출 프로세스를 세부적으로 안내합니다.
    *   **엔티티 식별**: 엔티티 이름, 유형, 설명을 추출하도록 지시합니다. 설명은 텍스트에 명시된 정보에 기반해야 하며, 추론이나 환각을 피해야 합니다.
    *   **관계 식별**: 명확히 관련된 엔티티 쌍을 식별하고, 관계 설명, 강도, 키워드를 추출하도록 지시합니다.
    *   **콘텐츠 키워드 식별**: 전체 텍스트의 주요 개념과 주제를 요약하는 고수준 키워드를 식별합니다.
    *   **출력 형식**: 엔티티는 `("entity"<|>이름<|>유형<|>설명)` 형식으로, 관계는 `("relationship"<|>소스<|>대상<|>설명<|>키워드<|>강도)` 형식으로 출력하도록 지정합니다. 목록 구분자는 `##`이며, 완료 시 `<|COMPLETE|>`을 출력합니다.

3.  **예제(Examples)**: 다양한 도메인(예: 인물, 기술, 회사, 시장 동향)에서 프롬프트가 어떻게 작동하는지 보여주는 구체적인 예제를 포함합니다. 이 예제들은 LLM이 기대되는 출력 형식을 이해하는 데 도움을 줍니다.

4.  **실제 데이터(Real Data)**: 사용자 입력 텍스트가 삽입되는 위치를 나타냅니다.

이 템플릿은 `{language}`, `{entity_types}`, `{examples}`, `{input_text}` 등의 플레이스홀더를 사용하여 런타임에 맞춤형 프롬프트를 동적으로 생성합니다. 이 구조는 일관성 있고 예측 가능한 출력을 보장하며, 시스템의 정확성과 신뢰성을 높