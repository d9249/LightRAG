# 캐시 무효화 전략

<cite>
**이 문서에서 참조된 파일**   
- [lightrag.py](file://lightrag\lightrag.py)
- [postgres_impl.py](file://lightrag\kg\postgres_impl.py)
</cite>

## 목차
1. [소개](#소개)
2. [LLM 응답 캐시 무효화](#llm-응답-캐시-무효화)
3. [PostgreSQL 기반 캐시 마이그레이션](#postgresql-기반-캐시-마이그레이션)
4. [작업 공간 기반 캐시 격리](#작업-공간-기반-캐시-격리)

## 소개
LightRAG는 대규모 언어 모델(LLM)의 응답을 캐싱하여 반복적인 계산을 방지하고 성능을 향상시키는 기능을 제공합니다. 이 문서는 LightRAG의 캐시 무효화 및 정리 메커니즘에 대해 설명합니다. 특히, `lightrag.py` 파일의 `aclear_cache` 메서드가 모든 LLM 응답 캐시를 삭제하는 절차와, PostgreSQL 기반 저장소에서 `_migrate_llm_cache_to_flattened_keys` 함수가 기존 캐시 키를 새로운 `{mode}:{cache_type}:{hash}` 형식으로 원자적으로 마이그레이션하는 과정을 분석합니다. 또한, 기존 레코드와의 ID 충돌을 방지하기 위한 `conflict_check_sql` 쿼리의 역할과, `update_time` 필드를 통해 갱신 시점을 추적하는 방법을 포함하며, 작업 공간(workspace) 기반 캐시 격리를 통한 데이터 무결성 유지 전략을 설명합니다.

## LLM 응답 캐시 무효화

`aclear_cache` 메서드는 LightRAG 인스턴스에 구성된 모든 LLM 응답 캐시를 삭제하는 비동기 함수입니다. 이 메서드는 캐시 저장소가 구성되어 있는지 확인한 후, `drop` 메서드를 호출하여 캐시 데이터를 완전히 제거합니다. `drop` 연산이 성공하면, `index_done_callback`을 호출하여 지속성을 보장합니다. 이 과정은 캐시 무효화 후 데이터의 일관성을 유지하고, 모든 변경 사항이 디스크에 반영되도록 합니다.

**Section sources**
- [lightrag.py](file://lightrag\lightrag.py#L2093-L2117)

## PostgreSQL 기반 캐시 마이그레이션

`_migrate_llm_cache_to_flattened_keys` 함수는 PostgreSQL 기반 저장소에서 기존 캐시 키를 새로운 평탄화된 형식으로 마이그레이션하는 역할을 합니다. 이 함수는 먼저 `id`가 콜론(`:`)을 포함하지 않는 레코드를 확인하여 마이그레이션이 필요한지 판단합니다. 마이그레이션이 필요할 경우, `conflict_check_sql` 쿼리를 사용하여 기존 레코드와의 ID 충돌을 확인합니다. 충돌이 발견되면 경고 메시지를 기록하지만, 마이그레이션을 계속 진행합니다. 이후, `UPDATE` 문을 사용하여 기존 `id`를 새로운 형식으로 변경하고, `cache_type` 필드를 설정하며, `update_time`을 현재 타임스탬프로 업데이트합니다. 이 과정은 원자적으로 수행되어 데이터 무결성을 보장합니다.

**Section sources**
- [postgres_impl.py](file://lightrag\kg\postgres_impl.py#L482-L563)

## 작업 공간 기반 캐시 격리

LightRAG는 작업 공간(workspace) 기반 캐시 격리를 통해 데이터 무결성을 유지합니다. 각 작업 공간은 고유한 캐시 저장소를 가지며, 이는 `workspace` 파라미터를 통해 구분됩니다. 이 메커니즘은 여러 사용자 또는 프로젝트가 동일한 LightRAG 인스턴스를 공유할 때, 캐시 데이터가 서로 간섭하지 않도록 합니다. 작업 공간 기반 격리는 캐시 무효화 및 마이그레이션 과정에서도 적용되어, 특정 작업 공간의 캐시만 영향을 받도록 합니다.

**Section sources**
- [lightrag.py](file://lightrag\lightrag.py#L2093-L2117)
- [postgres_impl.py](file://lightrag\kg\postgres_impl.py#L482-L563)