# 쿠버네티스 배포 최적화

<cite>
**이 문서에서 참조된 파일**  
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml)
- [02-install-database.sh](file://k8s-deploy/databases/02-install-database.sh)
- [README.md](file://k8s-deploy/README.md)
- [databases/README.md](file://k8s-deploy/databases/README.md)
- [neo4j_impl.py](file://lightrag/kg/neo4j_impl.py)
</cite>

## 목차
1. [소개](#소개)
2. [리소스 최적화 전략](#리소스-최적화-전략)
3. [CPU 및 메모리 설정](#cpu-및-메모리-설정)
4. [스토리지 구성](#스토리지-구성)
5. [복제본 및 클러스터 모드](#복제본-및-클러스터-모드)
6. [종료 정책 및 안정성](#종료-정책-및-안정성)
7. [프로덕션 환경 권장값](#프로덕션-환경-권장값)
8. [결론](#결론)

## 소개

이 문서는 LightRAG 프로젝트에서 제공하는 Neo4j 데이터베이스의 쿠버네티스 배포를 위한 리소스 최적화 전략을 설명합니다. `k8s-deploy/databases/neo4j/values.yaml` 파일을 기반으로 CPU, 메모리, 스토리지, 복제본 수 등의 핵심 설정 값을 조정하는 방법을 안내하며, 각 설정이 시스템 성능과 안정성에 미치는 영향을 분석합니다. 이 배포는 KubeBlocks를 통해 관리되며, Helm 차트를 사용하여 설치됩니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L1-L47)
- [README.md](file://k8s-deploy/README.md#L71-L103)

## 리소스 최적화 전략

Neo4j의 쿠버네티스 배포에서 리소스 최적화는 성능, 안정성, 비용 효율성을 극대화하는 데 핵심적인 역할을 합니다. `values.yaml` 파일은 배포의 핵심 구성 요소를 제어하는 데 사용되며, 이를 통해 프로덕션 워크로드에 맞게 리소스를 정밀하게 조정할 수 있습니다. 최적화 전략은 다음과 같은 원칙을 따릅니다:

1. **과도한 프로비저닝 방지**: 불필요한 리소스 할당은 클러스터 자원 낭비와 운영 비용 증가로 이어집니다.
2. **성능 요구사항 충족**: 데이터 양과 쿼리 복잡도에 따라 충분한 리소스를 확보하여 성능 저하를 방지합니다.
3. **안정성 확보**: 리소스 제한과 요청을 적절히 설정하여 노드의 OOM(Out of Memory) 종료를 방지하고, 시스템 전체의 안정성을 유지합니다.
4. **확장성 고려**: 초기 설정을 유연하게 구성하여 향후 워크로드 증가에 대비한 수평 및 수직 확장이 가능하도록 합니다.

이러한 전략은 `values.yaml` 파일의 각 파라미터를 조정함으로써 구현됩니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L1-L47)

## CPU 및 메모리 설정

### CPU 코어 수 (cpu)

`cpu` 설정은 Neo4j 컨테이너에 할당되는 CPU 코어 수를 정의합니다.

- **기본값**: 2
- **최소값**: 2
- **최대값**: 64

CPU 코어 수는 쿼리 처리 속도, 트랜잭션 처리량, 그래프 연산 성능에 직접적인 영향을 미칩니다. 저사양 워크로드의 경우 2코어로 충분할 수 있지만, 복잡한 그래프 탐색이나 고빈도 쿼리가 발생하는 환경에서는 4코어 이상을 권장합니다. CPU 리소스는 쿠버네티스에서 요청(request)과 제한(limit)으로 관리되며, 이 파일에서는 단일 값으로 설정되며, 내부적으로는 요청과 제한이 동일하게 설정될 가능성이 높습니다. 이는 리소스 보장과 예측 가능한 성능을 제공하지만, 갑작스러운 부하 증가 시 성능이 제한될 수 있습니다.

**성능 영향도**: CPU 코어 수를 늘리면 병렬 처리 능력이 향상되어 쿼리 응답 시간이 단축됩니다. 그러나 Neo4j의 내부 아키텍처 특성상, CPU 코어 수를 무작정 늘리는 것보다 적절한 메모리 설정과 함께 균형 있게 구성하는 것이 중요합니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L15-L19)

### 메모리 할당 (memory)

`memory` 설정은 Neo4j 컨테이너에 할당되는 메모리 양을 기가바이트(Gi) 단위로 정의합니다.

- **기본값**: 2
- **최소값**: 2
- **최대값**: 1000

메모리는 Neo4j 성능에서 가장 중요한 요소 중 하나입니다. Neo4j는 메모리 내 캐시(힙 메모리)를 활용하여 디스크 I/O를 최소화합니다. 충분한 메모리가 확보되면, 자주 접근하는 노드, 관계, 속성, 인덱스가 캐시에 유지되어 매우 빠른 쿼리 성능을 제공합니다. 이 설정은 쿠버네티스의 컨테이너 리소스 요청 및 제한으로 매핑되며, 설정된 값은 Neo4j JVM 힙 메모리 크기와 직접적인 연관이 있습니다.

**성능 영향도**: 메모리가 부족하면 캐시 미스(cache miss)가 빈번하게 발생하여 디스크에서 데이터를 읽어야 하므로 성능이 급격히 저하됩니다. 반대로, 과도한 메모리 할당은 자원 낭비이며, 가비지 컬렉션(GC) 주기가 길어져 일시적인 성능 저하(STW - Stop The World)가 발생할 수 있습니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L22-L26)

## 스토리지 구성

### 스토리지 크기 (storage)

`storage` 설정은 Neo4j 데이터 볼륨의 크기를 기가바이트(Gi) 단위로 정의합니다.

- **기본값**: 20
- **최소값**: 1
- **최대값**: 10000

이 값은 영구 볼륨 클레임(PVC)을 통해 프로비저닝되는 스토리지의 초기 크기를 결정합니다. 데이터베이스의 크기, 예상 성장률, 백업 전략을 고려하여 설정해야 합니다. 스토리지가 부족해지면 데이터베이스가 쓰기 작업을 수행할 수 없게 되어 서비스가 중단될 수 있습니다.

**성능 영향도**: 스토리지 크기 자체는 직접적인 성능에 영향을 주지 않지만, 스토리지가 가득 차면 성능 저하가 발생할 수 있습니다. 또한, 스토리지의 물리적 성능(예: SSD vs HDD)이 I/O 성능에 큰 영향을 미칩니다.

### 스토리지 클래스 (storageClassName)

`storageClassName` 설정은 PVC가 사용할 스토리지 클래스를 지정합니다.

- **기본값**: 빈 문자열 ("")
- **설정 방법**: 사용할 스토리지 클래스의 이름을 문자열로 입력합니다. 예: `storageClassName: "fast-ssd"`

스토리지 클래스는 스토리지의 품질, 성능, 재해 복구 정책을 정의합니다. 예를 들어, `standard` 클래스는 일반적인 스토리지를 제공할 수 있고, `fast-ssd` 클래스는 고성능 SSD 기반 스토리지를 제공할 수 있습니다. 이 값을 지정하지 않으면(빈 문자열), 클러스터의 기본 스토리지 클래스가 사용됩니다.

**성능 영향도**: 스토리지 클래스는 I/O 지연 시간(latency)과 처리량(throughput)에 결정적인 영향을 미칩니다. 고성능 워크로드의 경우, 반드시 고성능 스토리지 클래스를 지정해야 합니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L29-L37)

## 복제본 및 클러스터 모드

### 복제본 수 (replicas)

`replicas` 설정은 Neo4j 인스턴스의 복제본 수를 정의합니다.

- **기본값**: 1
- **최소값**: 1
- **최대값**: 5

이 설정은 `mode` 설정과 밀접하게 연관되어 있습니다. 현재 `values.yaml` 파일의 `mode`는 `singlealone`으로 설정되어 있으며, 이는 단일 인스턴스 모드를 의미합니다. 따라서 `replicas` 값은 1로 고정되어야 합니다. `replicas` 값을 1보다 크게 설정하면, `mode`가 `replicaset` 또는 `cluster`와 같은 복제 모드로 변경되어야 합니다.

**성능 영향도**: 단일 인스턴스 모드는 가장 간단한 배포 방식이지만, 가용성과 내결함성 측면에서 취약합니다. 복제본 수를 늘리면 읽기 확장성과 고가용성을 확보할 수 있지만, 쓰기 성능은 복제 지연으로 인해 약간 저하될 수 있습니다.

### 클러스터 모드 (mode)

`mode` 설정은 Neo4j의 클러스터 토폴로지를 정의합니다.

- **기본값**: singlealone
- **허용값**: [singlealone]

현재 설정은 단일 인스턴스 모드만을 지원합니다. 프로덕션 환경에서는 고가용성을 위해 `replicaset` 또는 `Causal Clustering` 모드를 사용하는 것이 이상적이지만, 이 Helm 차트는 현재 단일 인스턴스 배포만을 목적으로 설계된 것으로 보입니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L12-L13)
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L39-L43)

## 종료 정책 및 안정성

### terminationPolicy 설정

`extra.terminationPolicy` 설정은 데이터베이스 클러스터의 삭제 정책을 제어합니다.

- **기본값**: Delete

이 설정은 KubeBlocks 오퍼레이터에 의해 해석됩니다. `Delete` 정책은 `kubectl delete cluster <cluster-name>` 명령을 실행할 때, 클러스터와 연결된 모든 리소스(포드, PVC 등)를 완전히 삭제함을 의미합니다. 이는 개발 및 테스트 환경에서 유용하지만, 프로덕션 환경에서는 데이터 손실 위험이 매우 큽니다.

**안정성 영향도**: 이 설정은 시스템의 논리적 안정성보다는 운영 안정성과 데이터 보호에 더 큰 영향을 미칩니다. 실수로 클러스터를 삭제할 경우 데이터를 복구할 수 없으므로, 프로덕션 환경에서는 `terminationPolicy`를 `DoNotTerminate` 또는 `Halt`로 변경하여 삭제를 방지하거나, 삭제 시에도 PVC를 보존하는 정책을 사용하는 것이 안전합니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L45-L47)
- [README.md](file://k8s-deploy/README.md#L71-L103)

### 리소스 제한과 요청의 시스템 안정성 영향

쿠버네티스에서 리소스 요청(request)과 제한(limit)은 시스템 안정성의 핵심 요소입니다.

- **리소스 요청(request)**: 파드가 스케줄링될 때 필요한 최소 리소스 양입니다. 스케줄러는 이 값을 기반으로 파드를 실행할 수 있는 노드를 선택합니다. 요청이 너무 낮게 설정되면, 노드가 과부하되어 성능이 저하될 수 있습니다.
- **리소스 제한(limit)**: 파드가 사용할 수 있는 최대 리소스 양입니다. CPU 제한을 초과하면 파드가 CPU 스로틀링을 당하고, 메모리 제한을 초과하면 OOM Killer에 의해 파드가 종료될 수 있습니다.

`values.yaml` 파일의 `cpu`와 `memory` 설정은 이러한 요청과 제한을 정의합니다. 안정적인 운영을 위해서는 다음과 같은 점을 고려해야 합니다:
1. **요청과 제한의 균형**: 요청은 실제 워크로드의 평균 소비량에 근접하게 설정하고, 제한은 피크 부하를 감당할 수 있는 수준으로 설정해야 합니다.
2. **OOM 방지**: 메모리 제한은 Neo4j JVM 힙 크기보다 충분히 여유 있게 설정해야 합니다. JVM 외부의 네이티브 메모리(예: 페이지 캐시, 네트워크 버퍼)도 필요하기 때문입니다.
3. **노드 자원 고려**: 모든 파드의 리소스 요청 합계가 노드의 총 자원을 초과하지 않도록 해야 합니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L15-L26)

## 프로덕션 환경 권장값

프로덕션 환경에서의 안정성과 성능을 보장하기 위한 권장 설정은 다음과 같습니다.

| 설정 항목 | 권장값 | 비고 |
| :--- | :--- | :--- |
| **cpu** | 4 | 중간 규모 워크로드 기준. 고성능 요구 시 8 이상 고려 |
| **memory** | 8 | 충분한 캐시를 확보하기 위함. 데이터 양에 따라 16Gi 이상 필요할 수 있음 |
| **storage** | 100 | 초기 데이터 및 성장 여유 공간 확보 |
| **storageClassName** | `fast-ssd` | 고성능 I/O를 위한 SSD 기반 스토리지 클래스 지정 |
| **replicas** | 1 | 현재 `singlealone` 모드 제한 |
| **mode** | `singlealone` | 현재 지원되는 모드 |
| **terminationPolicy** | `DoNotTerminate` | 실수로 인한 데이터 삭제 방지 |

이 설정들은 일반적인 프로덕션 워크로드를 기준으로 하며, 실제 환경의 데이터 양, 쿼리 패턴, 트랜잭션 빈도 등을 모니터링하여 지속적으로 조정해야 합니다.

**Section sources**
- [values.yaml](file://k8s-deploy/databases/neo4j/values.yaml#L1-L47)

## 결론

`k8s-deploy/databases/neo4j/values.yaml` 파일은 Neo4j의 쿠버네티스